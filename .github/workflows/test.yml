name: Test workflow                    # Workflow 이름
on:                                  # Event 감지
  push:
    branches:
      - develop                 
jobs:                                # Job 설정
  deploy:
        name: CD
        runs-on: self-hosted
        defaults:
          run:
              working-directory: ../..
        steps:
        # - name: Get Github Actions IP
        #   id: ip
        #   uses: haythem/public-ip@v1.2

        # - name: Configure AWS Credentials
        #   uses: aws-actions/configure-aws-credentials@v1
        #   with:
        #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        #     aws-region: ap-northeast-2

        # - name: Add Github Actions IP to Security group
        #   run: |
        #     aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
  
        - name: run
          run: |
              cd test-chatUniv
              git pull origin develop
              yarn install
              if [ -f save_pid.txt ]; then
                kill -9 $(ps -ef | grep start | awk '{print $2}')
                rm save_pid.txt
              fi  
              nohup yarn start > my.log 2>&1 &
              echo $! > save_pid.txt
  
        # - name: Remove Github Actions IP From Security Group
        #   run: |
        #     aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32








        
